<?php require('includes/header.php'); ?>
<?php 
include("includes/config.php");

$id = $_GET["id"];
$category = $_GET["kategori"];
$model = $_GET["model"];

if($_POST){
  $title = $_POST["comment_title"];
  $content = $_POST["comment_content"];
  $product_id = $_GET["id"];
  $user = $_SESSION["name"]." ".$_SESSION["surname"];

  $result = mysqli_query($connection,"INSERT INTO comments(product_id,comment_user,comment_title,comment_content) VALUES('$product_id','$user','$title','$content')");
  if($result){
    header("location:/tr/urundetayi?id=$product_id&kategori=$category&model=$model&sayfa=1");
  }
}

if($_GET){
    $pageNumber = $_GET["sayfa"];
    $result = mysqli_query($connection,"SELECT * FROM products WHERE product_id = $id and category = '$category' and model = '$model'");
    $row = mysqli_fetch_array($result,MYSQLI_ASSOC);
    if(mysqli_num_rows($result)==1){
    echo '
    <ol class="breadcrumb" style="margin-top:10px;" >
    <li class="breadcrumb-item"><a href="/tr/anasayfa" style="color:#3752b7;">Anasayfa</a></li>
    <li class="breadcrumb-item"><a href="urunler?kategori='.$row["category"].'" style="color:#3752b7;">'.$row["category"].'</a></li>
    <li class="breadcrumb-item active">'.$row["title"].'</li>
    </ol>

    <div class="card" style="margin-bottom:50px;">
        <div class="card-header">
            <h6 style="text-align:center;"> <small> '.$row["subtitle"].' </small>  </h6>
        </div>
        <div class="card-body">   
            <img src="/static/media/'.$row["product_image"].'" height="800" style="max-width: 100%;height:auto;" class="img-fluid" alt="Responsive image">
            <nav>
                <div class="nav nav-tabs" id="nav-tab" role="tablist">';
                if($pageNumber==1){
                  echo '<a class="nav-item nav-link active" id="nav-home-tab" data-toggle="tab" href="#nav-home" role="tab" aria-controls="nav-home" aria-selected="true">Ürün Bilgileri</a>';
                }
                else{
                  echo '<a class="nav-item nav-link" id="nav-home-tab" data-toggle="tab" href="#nav-home" role="tab" aria-controls="nav-home" aria-selected="true">Ürün Bilgileri</a>';
                }
                if($pageNumber>1){
                  echo '<a class="nav-item nav-link active" id="nav-profile-tab" data-toggle="tab" href="#nav-profile" role="tab" aria-controls="nav-profile" aria-selected="false">Ürün Yorumları</a>';
                }
                else{
                  echo '<a class="nav-item nav-link" id="nav-profile-tab" data-toggle="tab" href="#nav-profile" role="tab" aria-controls="nav-profile" aria-selected="false">Ürün Yorumları</a>';
                }
                echo'             
                </div>
            </nav>
            <div class="tab-content" id="nav-tabContent">';
                if($pageNumber == 1){
                  echo '<div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">';
                }
                else{
                  echo '<div class="tab-pane fade" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">';
                }
                echo'<table class="table table-striped">
                <tbody>
                    <tr>
                        <td>Marka:</td>
                        <td>'.$row["brand"].'</td>
                    </tr>
                    <tr>
                        <td>Model:</td>
                        <td>'.$row["model"].'</td>
                    </tr>
                    <tr>
                        <td>Fiyat:</td>
                        <td>'.$row["price"].' ₺ <small> (kdv dahil)</small></td>
                    </tr>
                    <tr>
                        <td>Stok Sayısı:</td>
                        <td>'.$row["stock_amount"].'</td>
                    </tr>
                    <tr>
                        <td>Detay:</td>
                        <td>'.$row["product_detail"].'</td>
                    </tr>
                </tbody>
            </table>
              </div>';
              if($_GET['sayfa']==1){
                echo '<div class="tab-pane fade" id="nav-profile" style="margin-top:10px;" role="tabpanel" aria-labelledby="nav-profile-tab">';
              }
              else{
                echo '<div class="tab-pane fade show active" id="nav-profile" style="margin-top:10px;" role="tabpanel" aria-labelledby="nav-profile-tab">';  
              }
              $show = 5;
              $totalData = mysqli_query($connection,"SELECT COUNT(*) AS total FROM comments WHERE product_id = $id");
              $resultComment = mysqli_fetch_array($totalData);
              $totalComment = $resultComment['total'];
              $totalPage = ceil($totalComment / $show);

              $page = isset($pageNumber) ? (int) $pageNumber : 1;
              if($page < 1) $page = 1;
              if($page > $totalPage) $page = $totalPage;

              $limit = ($page -1) * $show;
              if($limit < 0)$limit = $limit * -1;
              $results = mysqli_query($connection,"SELECT * FROM comments WHERE product_id = $id LIMIT $limit,$show");
              if(mysqli_num_rows($results) == 0) echo'<div class="alert alert-danger" role="alert">Henüz yorum yapılmadı.</div>';
              else{
                while($comment = mysqli_fetch_array($results)){
                echo'  
                <div class="media">';
                  $username = $comment["comment_user"];
                  $userinfo = explode(" ",$username);
                  $cname = $userinfo[0];
                  $csurname = $userinfo[1];
                  $userAvatar = mysqli_query($connection,"SELECT avatar from users WHERE  name = '$cname' AND surname = '$csurname' ");
                  $cAvatar = mysqli_fetch_array($userAvatar,MYSQLI_ASSOC);
                  $cAvatarInfo = $cAvatar["avatar"];
                echo'
                  <img width="80" height="80"  style="margin-top:10px;" src="/static/media/avatar/'.$cAvatarInfo.'" class="mr-3" alt="...">
                  <div class="media-body" style="margin-top:10px;">
                    <h5 class="mt-0">'.$comment["comment_title"].' - '.$comment["comment_user"].'</h5>
                    '.$comment["comment_content"].'
                  </div>
                  </div>';
                }
              echo'
                <nav aria-label="Page navigation example">
                  <ul class="pagination" style="margin-top:25px;>';
                  if($totalPage >= $pageNumber && $page != 1){
                    echo'
                    <li class="page-item">
                      <a class="page-link" href="urundetayi?id='.$_GET['id'].'&kategori='.$_GET['kategori'].'&model='.$_GET['model'].'&sayfa='.($pageNumber-1).'" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                      </a>
                    </li>
                    ';
                  }
                    for($p=1;$p<=$totalPage;$p++){
                      if($page == $p){
                        echo '<li class="page-item"><a class="page-link">'.$p.'</a></li>';
                      }
                      else{
                        echo'
                          <li class="page-item"><a class="page-link" href="urundetayi?id='.$_GET['id'].'&kategori='.$_GET['kategori'].'&model='.$_GET['model'].'&sayfa='.$p.'">'.$p.'</a></li>';
                      }
                    }
                    if($pageNumber < $totalPage){
                      echo '
                      <li class="page-item">
                      <a class="page-link" href="urundetayi?id='.$_GET['id'].'&kategori='.$_GET['kategori'].'&model='.$_GET['model'].'&sayfa='.($pageNumber+1).'" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                      </a>
                      </li>
                      ';
                    }
                    echo'
                  </ul>
                </nav>';
            }
            echo '</div>
            </div>
            <div class="card" style="">
                <div class="card-body">
                <h3>Yorum Yap</h3><hr>';
            if(isset($_SESSION["name"])){
                echo'
                <form action="/tr/urundetayi?id='.$id.'&kategori='.$category.'&model='.$model.'" method="POST">
                    <h6 class="card-subtitle mb-2 text-muted">Başlık</h6>
                    <input class="form-control" name="comment_title" type="text" value=""><br>
                    <h6 class="card-subtitle mb-2 text-muted">Yorum</h6>
                    <textarea class="form-control"  name="comment_content"></textarea><br>
                    <button type="submit" class="btn btn-success">Yorum Yap</button>
                </form>
            ';
        }else{
            echo'
            <div class="alert alert-danger" role="alert">Yorum yapabilmek için önce <a href="/signin">giriş</a> yapın.</div>
            ';
        }
    }
}
?>  
        </div>
    </div>        
    </div>
    </div>  
<?php require('includes/footer.php'); ?>