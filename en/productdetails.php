<?php require('includes/header.php'); ?>
<?php 
include("includes/config.php");

$id = $_GET["id"];
$category = $_GET["category"];
$model = $_GET["model"];


if($_POST){
  $title = $_POST["comment_title"];
  $content = $_POST["comment_content"];
  $product_id = $_GET["id"];
  $user = $_SESSION["name"]." ".$_SESSION["surname"];

  $result = mysqli_query($connection,"INSERT INTO comments(product_id,comment_user,comment_title,comment_content) VALUES('$product_id','$user','$title','$content')");
  if($result){
    header("location:/en/productdetails?id=$product_id&category=$category&model=$model&page=1");
  }
}

if($_GET){
    $pageNumber = $_GET["page"];
    $result = mysqli_query($connection,"SELECT * FROM products WHERE product_id = $id and category = '$category' and model = '$model'");
    $row = mysqli_fetch_array($result,MYSQLI_ASSOC);
    if(mysqli_num_rows($result)==1){
    echo '
    <ol class="breadcrumb" style="margin-top:10px;" >
    <li class="breadcrumb-item"><a href="/en/home" style="color:#3752b7;">Home</a></li>
    <li class="breadcrumb-item"><a href="products?category='.$row["category"].'" style="color:#3752b7;">'.$row["category"].'</a></li>
    <li class="breadcrumb-item active">'.$row["title"].'</li>
    </ol>';

    if(isset($_GET["error_b"]))echo'<div class="alert alert-danger">Edit the order piece and to order try.</div>';
    echo'
    <div class="card" style="margin-bottom:50px;">
        <div class="card-header">
            <h6 style="text-align:center;"> <small> '.$row["subtitle"].' </small>  </h6>
        </div>
        <div class="card-body">   
            <img src="/static/media/'.$row["product_image"].'" height="800" style="max-width: 100%;height:auto;" class="img-fluid" alt="Responsive image">
            <div class="card" style="width: 18rem;float:right;">
            <div class="card-body">
              <h5 class="card-title">Order</h5>';
              if(isset($_SESSION["logged_in"])){
                echo'
                  <form action="../addtobasketcontroller?id='.$id.'&brand='.$row["brand"].'&model='.$row["model"].'&price='.$row["price"].'&stock_amount='.$row["stock_amount"].'&category='.$row["category"].'&image='.$row["product_image"].'&lang=en"method="POST">
                    <input class="form-control" name="piece" type="text" value="" placeholder="Piece"><br>
                    <button class="btn btn-primary my-2 my-sm-0" type="submit">Add to Basket</button>
                  </form>
                ';
              }
              echo'
              <a href="/en/buyquickly?brand='.$row["brand"].'&model='.$row["model"].'" style="margin-top:5px;"class="btn btn-primary">Buy Quickly</a>
            </div>
          </div>
          </div>            
            <nav>
                <div class="nav nav-tabs" id="nav-tab" role="tablist">';
                if($pageNumber==1){
                  echo '<a class="nav-item nav-link active" id="nav-home-tab" data-toggle="tab" href="#nav-home" role="tab" aria-controls="nav-home" aria-selected="true">Product Info</a>';
                }
                else{
                  echo '<a class="nav-item nav-link" id="nav-home-tab" data-toggle="tab" href="#nav-home" role="tab" aria-controls="nav-home" aria-selected="true">Product Info</a>';
                }
                if($pageNumber>1){
                  echo '<a class="nav-item nav-link active" id="nav-profile-tab" data-toggle="tab" href="#nav-profile" role="tab" aria-controls="nav-profile" aria-selected="false">Product Comments</a>';
                }
                else{
                  echo '<a class="nav-item nav-link" id="nav-profile-tab" data-toggle="tab" href="#nav-profile" role="tab" aria-controls="nav-profile" aria-selected="false">Product Comments</a>';
                }
                echo'             
                </div>
            </nav>
            <div class="tab-content" id="nav-tabContent">';
                if($pageNumber == 1){
                  echo '<div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">';
                }
                else{
                  echo '<div class="tab-pane fade" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">';
                }
                echo'<table class="table table-striped">
                <tbody>
                    <tr>
                        <td>Brand:</td>
                        <td>'.$row["brand"].'</td>
                    </tr>
                    <tr>
                        <td>Model:</td>
                        <td>'.$row["model"].'</td>
                    </tr>
                    <tr>
                        <td>Price:</td>
                        <td>'.$row["price"].' â‚º <small> (with the inclusion of kdv)</small></td>
                    </tr>
                    <tr>
                        <td>Stock Quantity:</td>
                        <td>'.$row["stock_amount"].'</td>
                    </tr>
                    <tr>
                        <td>Details:</td>
                        <td>'.$row["product_detail"].'</td>
                    </tr>
                </tbody>
            </table>
              </div>';
              if($_GET['page']==1){
                echo '<div class="tab-pane fade" id="nav-profile" style="margin-top:10px;" role="tabpanel" aria-labelledby="nav-profile-tab">';
              }
              else{
                echo '<div class="tab-pane fade show active" id="nav-profile" style="margin-top:10px;" role="tabpanel" aria-labelledby="nav-profile-tab">';  
              }
              $show = 5;
              $totalData = mysqli_query($connection,"SELECT COUNT(*) AS total FROM comments WHERE product_id = $id");
              $resultComment = mysqli_fetch_array($totalData);
              $totalComment = $resultComment['total'];
              $totalPage = ceil($totalComment / $show);

              $page = isset($pageNumber) ? (int) $pageNumber : 1;
              if($page < 1) $page = 1;
              if($page > $totalPage) $page = $totalPage;

              $limit = ($page -1) * $show;
              if($limit < 0)$limit = $limit * -1;
              $result = mysqli_query($connection,"SELECT * FROM comments WHERE product_id = $id LIMIT $limit,$show");
              if(mysqli_num_rows($result) == 0)echo'<div class="alert alert-danger" role="alert">No comment.</div>';
              else{
                while($comment = mysqli_fetch_array($result)){
                echo'  
                <div class="media">';
                  $username = $comment["comment_user"];
                  $userinfo = explode(" ",$username);
                  $cname = $userinfo[0];
                  $csurname = $userinfo[1];
                  $userAvatar = mysqli_query($connection,"SELECT avatar from users WHERE  name = '$cname' AND surname = '$csurname' ");
                  $cAvatar = mysqli_fetch_array($userAvatar,MYSQLI_ASSOC);
                  $cAvatarInfo = $cAvatar["avatar"];
                echo'
                  <img width="80" height="80"  style="margin-top:10px;" src="/static/media/avatar/'.$cAvatarInfo.'" class="mr-3" alt="...">
                  <div class="media-body" style="margin-top:10px;">
                    <h5 class="mt-0">'.$comment["comment_title"].'</h5>
                    '.$comment["comment_content"].'
                  </div>
                  </div>';
                }
              echo'
                <nav aria-label="Page navigation example">
                  <ul class="pagination" style="margin-top:25px;>';
                  if($totalPage <= $pageNumber){
                    echo'
                    <li class="page-item">
                      <a class="page-link" href="productdetails?id='.$_GET['id'].'&category='.$_GET['category'].'&model='.$_GET['model'].'&page='.($pageNumber-1).'" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                      </a>
                    </li>
                    ';
                  }
                    for($p=1;$p<=$totalPage;$p++){
                      if($page == $p){
                        echo '<li class="page-item"><a class="page-link">'.$p.'</a></li>';
                      }
                      else{
                        echo'
                          <li class="page-item"><a class="page-link" href="productdetails?id='.$_GET['id'].'&category='.$_GET['category'].'&model='.$_GET['model'].'&page='.$p.'">'.$p.'</a></li>';
                      }
                    }
                    if($pageNumber < $totalPage){
                      echo '
                      <li class="page-item">
                      <a class="page-link" href="productdetails?id='.$_GET['id'].'&category='.$_GET['category'].'&model='.$_GET['model'].'&page='.($pageNumber+1).'" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                      </a>
                      </li>
                      ';
                    }
                    echo'
                  </ul>
                </nav>';
            }
            echo '</div>
            </div>
            <div class="card" style="">
                <div class="card-body">
                <h3>Do Comment</h3><hr>';
            if(isset($_SESSION["name"])){
                echo'
                <form action="/en/productdetails?id='.$id.'&category='.$category.'&model='.$model.'" method="POST">
                    <h6 class="card-subtitle mb-2 text-muted">Comment Title</h6>
                    <input class="form-control" name="comment_title" type="text" value=""><br>
                    <h6 class="card-subtitle mb-2 text-muted">Comment</h6>
                    <textarea class="form-control"  name="comment_content"></textarea><br>
                    <button type="submit" class="btn btn-success">Do Comment</button>
                </form>
            ';
        }else{
            echo'
            <div class="alert alert-danger" role="alert">Please do <a href="/en/signin">Login</a> first.</div>
            ';
        }
    }
}
?>  
        </div>
      </div>        
    </div>
  </div>  
<?php require('includes/footer.php'); ?>